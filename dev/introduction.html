<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>clickhouse_sinker | clickhouse_sinker</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="clickhouse_sinker a tool to sink the data into ClickHouse">
    
    <link rel="preload" href="/clickhouse_sinker/assets/css/0.styles.b6b8b40f.css" as="style"><link rel="preload" href="/clickhouse_sinker/assets/js/app.b4dffbc3.js" as="script"><link rel="preload" href="/clickhouse_sinker/assets/js/3.133b48d1.js" as="script"><link rel="preload" href="/clickhouse_sinker/assets/js/14.b8380f5f.js" as="script"><link rel="prefetch" href="/clickhouse_sinker/assets/js/10.0196721a.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/11.d935413b.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/12.41ca2c66.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/13.26b83bf9.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/15.93e44e94.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/16.9ce653d9.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/17.e5979b4a.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/18.435ff185.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/19.d75221be.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/4.dba3fbed.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/5.2fd5f6d7.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/6.777aa5db.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/7.1555d465.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/8.4197f438.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/9.66193bba.js"><link rel="prefetch" href="/clickhouse_sinker/assets/js/vendors~docsearch.e5d89337.js">
    <link rel="stylesheet" href="/clickhouse_sinker/assets/css/0.styles.b6b8b40f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/clickhouse_sinker/" class="home-link router-link-active"><!----> <span class="site-name">clickhouse_sinker</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/clickhouse_sinker/guide/install.html" class="nav-link">
  Get Started
</a></div><div class="nav-item"><a href="/clickhouse_sinker/dev/introduction.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Introduction
</a></div><div class="nav-item"><a href="/clickhouse_sinker/configuration/flag.html" class="nav-link">
  Configuration
</a></div><div class="nav-item"><a href="https://github.com/housepower/clickhouse_sinker" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Languages" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Languages" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/clickhouse_sinker/dev/introduction.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  English
</a></li><li class="dropdown-item"><!----> <a href="/clickhouse_sinker/zh/" class="nav-link">
  zh-CN
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/clickhouse_sinker/guide/install.html" class="nav-link">
  Get Started
</a></div><div class="nav-item"><a href="/clickhouse_sinker/dev/introduction.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Introduction
</a></div><div class="nav-item"><a href="/clickhouse_sinker/configuration/flag.html" class="nav-link">
  Configuration
</a></div><div class="nav-item"><a href="https://github.com/housepower/clickhouse_sinker" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Languages" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Languages" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/clickhouse_sinker/dev/introduction.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  English
</a></li><li class="dropdown-item"><!----> <a href="/clickhouse_sinker/zh/" class="nav-link">
  zh-CN
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/clickhouse_sinker/dev/introduction.html" aria-current="page" class="active sidebar-link">Introduction</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/clickhouse_sinker/dev/introduction.html#features" class="sidebar-link">Features</a></li><li class="sidebar-sub-header"><a href="/clickhouse_sinker/dev/introduction.html#supported-data-types" class="sidebar-link">Supported data types</a></li><li class="sidebar-sub-header"><a href="/clickhouse_sinker/dev/introduction.html#configuration" class="sidebar-link">Configuration</a></li><li class="sidebar-sub-header"><a href="/clickhouse_sinker/dev/introduction.html#configuration-management" class="sidebar-link">Configuration Management</a></li><li class="sidebar-sub-header"><a href="/clickhouse_sinker/dev/introduction.html#prometheus-metrics" class="sidebar-link">Prometheus Metrics</a></li><li class="sidebar-sub-header"><a href="/clickhouse_sinker/dev/introduction.html#extending" class="sidebar-link">Extending</a></li><li class="sidebar-sub-header"><a href="/clickhouse_sinker/dev/introduction.html#why-not-kafka-engine-built-in-clickhouse" class="sidebar-link">Why not Kafka Engine built in ClickHouse?</a></li><li class="sidebar-sub-header"><a href="/clickhouse_sinker/dev/introduction.html#kafka-compatibility" class="sidebar-link">Kafka Compatibility</a></li></ul></li><li><a href="/clickhouse_sinker/dev/design.html" class="sidebar-link">Design</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="clickhouse-sinker"><a href="#clickhouse-sinker" class="header-anchor">#</a> clickhouse_sinker</h1> <p><a href="https://travis-ci.com/housepower/clickhouse_sinker" target="_blank" rel="noopener noreferrer"><img src="https://travis-ci.com/housepower/clickhouse_sinker.svg?branch=master" alt="Build Status"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <a href="https://goreportcard.com/report/github.com/housepower/clickhouse_sinker" target="_blank" rel="noopener noreferrer"><img src="https://goreportcard.com/badge/github.com/housepower/clickhouse_sinker" alt="Go Report Card"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>clickhouse_sinker is a sinker program that transfer kafka message into <a href="https://clickhouse.yandex/" target="_blank" rel="noopener noreferrer">ClickHouse<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <p>Refers to <a href="/clickhouse_sinker/dev/design.html">design</a> for how it works.</p> <h2 id="features"><a href="#features" class="header-anchor">#</a> Features</h2> <ul><li>Uses native ClickHouse client-server TCP protocol, with higher performance than HTTP.</li> <li>Easy to use and deploy, you don't need write any hard code, just care about the configuration file</li> <li>Support multiple parsers: fastjson(recommended), gjson, csv.</li> <li>Support multiple Kafka client: kafka-go(recommended), sarama.</li> <li>Support multiple Kafka security mechanisms: SSL, SASL/PLAIN, SASL/SCRAM, SASL/GSSAPI and combinations of them.</li> <li>Support multiple sinker tasks, each runs on parallel.</li> <li>Support multiple kafka and ClickHouse clusters.</li> <li>Bulk insert (by config <code>bufferSize</code> and <code>flushInterval</code>).</li> <li>Parse messages concurrently.</li> <li>Write batches concurrently.</li> <li>Every batch is routed to a determined clickhouse shard. Exit if loop write fail.</li> <li>Custom sharding policy (by config <code>shardingKey</code> and <code>shardingPolicy</code>).</li> <li>Tolerate replica single-point-failure.</li> <li>At least once delivery guarantee.</li> <li>Dynamic config management with Nacos.</li></ul> <h2 id="supported-data-types"><a href="#supported-data-types" class="header-anchor">#</a> Supported data types</h2> <ul><li>[x] UInt8, UInt16, UInt32, UInt64, Int8, Int16, Int32, Int64</li> <li>[x] Float32, Float64</li> <li>[x] String</li> <li>[x] FixedString</li> <li>[x] Date, DateTime, DateTime64 (custom layout parser)</li> <li>[x] Array(UInt8, UInt16, UInt32, UInt64, Int8, Int16, Int32, Int64)</li> <li>[x] Array(Float32, Float64)</li> <li>[x] Array(String)</li> <li>[x] Array(FixedString)</li> <li>[x] Nullable</li> <li>[x] <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/date.html" target="_blank" rel="noopener noreferrer">ElasticDateTime<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> =&gt; Int64 (2019-12-16T12:10:30Z =&gt; 1576498230)</li></ul> <h2 id="configuration"><a href="#configuration" class="header-anchor">#</a> Configuration</h2> <p>Refers to how <a href="./go.test.sh">integration test</a> use the <a href="./docker/config.json">example config</a>.
Also refers to <a href="./config/config.go">code</a> for all config items.</p> <h3 id="kafka-encryption"><a href="#kafka-encryption" class="header-anchor">#</a> Kafka Encryption</h3> <p>clickhouse_sinker supports following encryption mechanisms:</p> <ul><li>No encryption</li></ul> <p>An example kafka config:</p> <div class="language- extra-class"><pre class="language-text"><code>    &quot;kfk1&quot;: {
      &quot;brokers&quot;: &quot;192.168.31.64:9092&quot;,
      &quot;@version&quot;: &quot;Required if you use sarama. It's the the Kafka server version.&quot;,
      &quot;version&quot;: &quot;2.2.1&quot;
    }
</code></pre></div><ul><li>Encryption using SSL</li></ul> <p>An example kafka config:</p> <div class="language- extra-class"><pre class="language-text"><code>    &quot;kfk2&quot;: {
      &quot;brokers&quot;: &quot;192.168.31.64:9093&quot;,
      &quot;version&quot;: &quot;2.2.1&quot;,
      &quot;tls&quot;: {
        &quot;enable&quot;: true,
        &quot;@caCertFiles&quot;: &quot;Required. It's the CA certificate with which Kafka brokers certs be signed. This cert is added to kafka.client.truststore.jks which kafka-console-consumer.sh uses&quot;,
        &quot;caCertFiles&quot;: &quot;/etc/security/ca-cert&quot;,
        &quot;@insecureSkipVerify&quot;: &quot;Whether disable broker FQDN verification. Set it to `true` if kafka-console-consumer.sh uses `ssl.endpoint.identification.algorithm=`.&quot;,
        &quot;insecureSkipVerify&quot;: true
      }
    }
</code></pre></div><p>FYI. <code>kafka-console-consumer.sh</code> works as the following setup:</p> <div class="language- extra-class"><pre class="language-text"><code>$ cat config/SSL_NOAUTH_client.properties
security.protocol=SSL
ssl.truststore.location=/etc/security/kafka.client.truststore.jks
ssl.truststore.password=123456
ssl.endpoint.identification.algorithm=

$ bin/kafka-console-consumer.sh --bootstrap-server 192.168.31.64:9094 --topic sunshine --group test-consumer-group --from-beginning --consumer.config config/SSL_NOAUTH_client.properties
</code></pre></div><p>Please follow <a href="https://kafka.apache.org/documentation/#security_ssl" target="_blank" rel="noopener noreferrer"><code>Kafka SSL setup</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. Use <code>-keyalg RSA</code> when you create the broker keystore, otherwise there will be no cipher suites in common between the keystore and those Golang supports. See <a href="https://github.com/Shopify/sarama/issues/643#issuecomment-216839760" target="_blank" rel="noopener noreferrer">this<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> for reference.</p> <h3 id="kafka-authentication"><a href="#kafka-authentication" class="header-anchor">#</a> Kafka Authentication</h3> <p>clickhouse_sinker support following following authentication mechanisms:</p> <ul><li>No authentication</li></ul> <p>An example kafka config:</p> <div class="language- extra-class"><pre class="language-text"><code>    &quot;kfk1&quot;: {
      &quot;brokers&quot;: &quot;192.168.31.64:9092&quot;,
      &quot;@version&quot;: &quot;Required if you use sarama. It's the the Kafka server version.&quot;,
      &quot;version&quot;: &quot;2.2.1&quot;
    }
</code></pre></div><ul><li>SASL/PLAIN</li></ul> <p>An example kafka config:</p> <div class="language- extra-class"><pre class="language-text"><code>    &quot;kfk3&quot;: {
      &quot;brokers&quot;: &quot;192.168.31.64:9094&quot;,
      &quot;version&quot;: &quot;2.2.1&quot;,
      &quot;sasl&quot;: {
        &quot;enable&quot;: true,
        &quot;mechanism&quot;: &quot;PLAIN&quot;,
        &quot;username&quot;: &quot;alice&quot;,
        &quot;password&quot;: &quot;alice-secret&quot;
      }
    }
</code></pre></div><p>FYI. Java clients work with the following setup:</p> <div class="language- extra-class"><pre class="language-text"><code>$ cat config/PLAINTEXT_PLAIN_client.properties
security.protocol=SASL_PLAINTEXT
sasl.kerberos.service.name=kafka
sasl.mechanism=PLAIN
sasl.jaas.config=org.apache.kafka.common.security.plain.PlainLoginModule required username=&quot;alice&quot; password=&quot;alice-secret&quot;;

$ bin/kafka-console-producer.sh --broker-list 192.168.31.64:9094 --topic sunshine --producer.config config/PLAINTEXT_PLAIN_client.properties

$ bin/kafka-console-consumer.sh --bootstrap-server 192.168.31.64:9094 --topic sunshine --group test-consumer-group --from-beginning --consumer.config config/PLAINTEXT_PLAIN_client.properties
</code></pre></div><ul><li>SASL/SCRAM</li></ul> <p>An example kafka config:</p> <div class="language- extra-class"><pre class="language-text"><code>    &quot;kfk4&quot;: {
      &quot;brokers&quot;: &quot;192.168.31.64:9094&quot;,
      &quot;version&quot;: &quot;2.2.1&quot;,
      &quot;sasl&quot;: {
        &quot;enable&quot;: true,
        &quot;@mechanism&quot;: &quot;SCRAM-SHA-256 or SCRAM-SHA-512&quot;,
        &quot;mechanism&quot;: &quot;SCRAM-SHA-256&quot;,
        &quot;username&quot;: &quot;alice&quot;,
        &quot;password&quot;: &quot;alice-secret&quot;
      }
    }
</code></pre></div><p>FYI. Java clients work with the following setup:</p> <div class="language- extra-class"><pre class="language-text"><code>$ cat config/PLAINTEXT_SCRAM_client.properties
security.protocol=SASL_PLAINTEXT
sasl.kerberos.service.name=kafka
sasl.mechanism=SCRAM-SHA-256
sasl.jaas.config=org.apache.kafka.common.security.scram.ScramLoginModule required username=&quot;alice&quot; password=&quot;alice-secret&quot;;

$ bin/kafka-console-producer.sh --broker-list 192.168.31.64:9094 --topic sunshine --producer.config config/PLAINTEXT_SCRAM_client.properties

$ bin/kafka-console-consumer.sh --bootstrap-server 192.168.31.64:9094 --topic sunshine --group test-consumer-group --from-beginning --consumer.config config/PLAINTEXT_SCRAM_client.properties
</code></pre></div><ul><li>SASL/GSSAPI(Kerberos)</li></ul> <p>An example kafka config:</p> <div class="language- extra-class"><pre class="language-text"><code>    &quot;kfk5&quot;: {
      &quot;brokers&quot;: &quot;192.168.31.64:9094&quot;,
      &quot;version&quot;: &quot;2.2.1&quot;,
      &quot;sasl&quot;: {
        &quot;enable&quot;: true,
        &quot;mechanism&quot;: &quot;GSSAPI&quot;,
        &quot;gssapi&quot;: {
          &quot;@authtype&quot;: &quot;1 - Username and password, 2 - Keytab&quot;,
          &quot;authtype&quot;: 2,
          &quot;keytabpath&quot;: &quot;/etc/security/mmmtest.keytab&quot;,
          &quot;kerberosconfigpath&quot;: &quot;/etc/krb5.conf&quot;,
          &quot;servicename&quot;: &quot;kafka&quot;,
          &quot;@username&quot;: &quot;`principal` consists of `username` `@` `realm`&quot;,
          &quot;username&quot;: &quot;mmm&quot;,
          &quot;realm&quot;: &quot;ALANWANG.COM&quot;
        }
      }
    }
</code></pre></div><p>FYI. Java clients work with the following setup:</p> <div class="language- extra-class"><pre class="language-text"><code>$ cat config/PLAINTEXT_GSSAPI_client.properties
security.protocol=SASL_PLAINTEXT
sasl.kerberos.service.name=kafka
sasl.mechanism=GSSAPI
sasl.jaas.config=com.sun.security.auth.module.Krb5LoginModule required useKeyTab=true storeKey=true debug=true keyTab=&quot;/etc/security/mmmtest.keytab&quot; principal=&quot;mmm@ALANWANG.COM&quot;;

$ bin/kafka-console-producer.sh --broker-list 192.168.31.64:9094 --topic sunshine --producer.config config/PLAINTEXT_GSSAPI_client.properties

$ bin/kafka-console-consumer.sh --bootstrap-server 192.168.31.64:9094 --topic sunshine --group test-consumer-group --from-beginning --consumer.config config/PLAINTEXT_GSSAPI_client.properties
</code></pre></div><p>Kerberos setup is complex. Please ensure <a href="https://docs.cloudera.com/runtime/7.2.1/kafka-managing/topics/kafka-manage-cli-consumer.html" target="_blank" rel="noopener noreferrer"><code>kafka-console-consumer.sh</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> Kerberos keytab authentication work STRICTLY FOLLOW <a href="https://stackoverflow.com/questions/48744660/kafka-console-consumer-with-kerberos-authentication/49140414#49140414" target="_blank" rel="noopener noreferrer">this article<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, then test <code>clickhouse_sinker</code> Kerberos authentication on the SAME machine which <code>kafka-console-consumer.sh</code> runs. I tested sarama Kerberos authentication against Kafka <a href="https://archive.apache.org/dist/kafka/2.2.1/kafka_2.11-2.2.1.tgz" target="_blank" rel="noopener noreferrer">2.2.1<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. Not sure other Kafka versions work.</p> <h3 id="sharding-policy"><a href="#sharding-policy" class="header-anchor">#</a> Sharding Policy</h3> <p>Every message is routed to a determined ClickHouse shard.</p> <p>By default, the shard number is caculated by <code>(kafka_offset/roundup(batch_size))%clickhouse_shards</code>, where <code>roundup()</code> round upward an unsigned integer to the the nearest 2^n.</p> <p>This above expression can be customized with <code>shardingKey</code> and <code>shardingPolicy</code>. <code>shardingKey</code> value is a column name. <code>shardingPolicy</code> value could be:</p> <ul><li><code>stripe,&lt;size&gt;</code>. This requires <code>shardingKey</code> be a numeric-like (bool, int, float, date etc.) column. The expression is <code>(uint64(shardingKey)/stripe_size)%clickhouse_shards</code>.</li> <li><code>hash</code>. This requires <code>shardingKey</code> be a string-like column. The hash function used internally is <a href="https://github.com/cespare/xxhash" target="_blank" rel="noopener noreferrer">xxHash64<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. The expression is <code>xxhash64(string(shardingKey))%clickhouse_shards</code>.</li></ul> <h2 id="configuration-management"><a href="#configuration-management" class="header-anchor">#</a> Configuration Management</h2> <p>The precedence of config items:</p> <ul><li>CLI parameters &gt; env variables</li> <li>Nacos &gt; Consul &gt; Local Config File &gt; Local Config Dir</li></ul> <h3 id="nacos"><a href="#nacos" class="header-anchor">#</a> Nacos</h3> <p>Sinker is able to register with Nacos, get and apply config changes dynamically without restart the whole process.
Controled by:</p> <ul><li>CLI parameters: <code>nacos-register-enable, nacos-addr, nacos-namespace-id, nacos-group, nacos-username, nacos-password</code></li> <li>env variables: <code>NACOS_REGISTER_ENABLE, NACOS_ADDR, NACOS_NAMESPACE_ID, NACOS_GROUP, NACOS_USERNAME, NACOS_PASSWORD</code></li></ul> <h3 id="consul"><a href="#consul" class="header-anchor">#</a> Consul</h3> <p>Currently sinker is able to register with Consul, but unable to get config.
Controled by:</p> <ul><li>CLI parameters: <code>consul-register-enable, consul-addr, consul-deregister-critical-services-after</code></li> <li>env variables: <code>CONSUL_REGISTER_ENABLE, CONSUL_ADDR, CONSUL_DEREGISTER_CRITICAL_SERVICES_AFTER</code></li></ul> <h3 id="local-files"><a href="#local-files" class="header-anchor">#</a> Local Files</h3> <p>Currently sinker is able to parse local config files at startup, but unable to detect file changes.
Controled by:</p> <ul><li>CLI parameters: <code>local-cfg-file, local-cfg-dir</code></li> <li>env variables: <code>LOCAL_CFG_FILE, LOCAL_CFG_DIR</code></li></ul> <h2 id="prometheus-metrics"><a href="#prometheus-metrics" class="header-anchor">#</a> Prometheus Metrics</h2> <p>All metrics are defined in <code>statistics.go</code>. You can create Grafana dashboard for clickhouse_sinker by importing the template <code>clickhouse_sinker-dashboard.json</code>.</p> <ul><li>Pull with prometheus</li></ul> <p>Metrics are exposed at <code>http://ip:port/metrics</code>. IP is the outbound IP of this machine. Port is from CLI <code>--http-port</code> or env <code>HTTP_PORT</code>.</p> <p>Sinker registers with Nacos if CLI <code>--consul-register-enable</code> or env <code>CONSUL_REGISTER_ENABLE</code> is present. However Prometheus is <a href="https://github.com/alibaba/nacos/issues/1032" target="_blank" rel="noopener noreferrer">unable<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> to obtain dynamic service list from nacos server.</p> <ul><li>Push to promethues</li></ul> <p>If CLI <code>--metric-push-gateway-addrs</code> or env <code>METRIC_PUSH_GATEWAY_ADDRS</code> (a list of comma-separated urls) is present, metrics are pushed to one of given URLs regualarly.</p> <h2 id="extending"><a href="#extending" class="header-anchor">#</a> Extending</h2> <p>There are several abstract interfaces which you can implement to support more message format, message queue and config management mechanism.</p> <div class="language- extra-class"><pre class="language-text"><code>type Parser interface {
	Parse(bs []byte) model.Metric
}

type Inputer interface {
	Init(cfg *config.Config, taskName string, putFn func(msg model.InputMessage)) error
	Run(ctx context.Context)
	Stop() error
	CommitMessages(ctx context.Context, message *model.InputMessage) error
}

// RemoteConfManager can be implemented by many backends: Nacos, Consul, etcd, ZooKeeper...
type RemoteConfManager interface {
	Init(properties map[string]interface{}) error
	// Register this instance, and keep-alive via heartbeat.
	Register(ip string, port int) error
	Deregister(ip string, port int) error
	// GetInstances fetchs healthy instances.
	// Mature service-discovery solutions(Nacos, Consul etc.) have client side cache
	// so that frequent invoking of GetInstances() and GetGlobalConfig() don't harm.
	GetInstances() (instances []Instance, err error)
	// GetConfig fetchs the config. The manager shall not reference the returned Config object after call.
	GetConfig() (conf *Config, err error)
	// PublishConfig publishs the config. The manager shall not reference the passed Config object after call.
	PublishConfig(conf *Config) (err error)
}

</code></pre></div><h2 id="why-not-kafka-engine-built-in-clickhouse"><a href="#why-not-kafka-engine-built-in-clickhouse" class="header-anchor">#</a> Why not <a href="https://clickhouse.tech/docs/en/engines/table-engines/integrations/kafka/" target="_blank" rel="noopener noreferrer"><code>Kafka Engine</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> built in ClickHouse?</h2> <ul><li>My experience indicates <code>Kafka Engine</code> is complicated, buggy and hard to debug.</li> <li><code>Kafka Engine</code> runs inside the db process, lowers the database stability. On the other side, <a href="https://www.vertica.com/" target="_blank" rel="noopener noreferrer">Vertica<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>'s official kafka importer is separated with the database server.</li> <li><code>Kafka Engine</code> doesn't support custom sharding policy.</li> <li>Neither <code>Kafka Engine</code> nor clickhouse_sinker support exactly-once.</li></ul> <h2 id="kafka-compatibility"><a href="#kafka-compatibility" class="header-anchor">#</a> Kafka Compatibility</h2> <p>Kafka broker <a href="https://kafka.apache.org/protocol#api_versions" target="_blank" rel="noopener noreferrer">exposes versions of various APIs it supports since 0.10.0.0<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h3 id="kafka-go"><a href="#kafka-go" class="header-anchor">#</a> Kafka-go</h3> <ul><li>Kafka-go <a href="https://github.com/segmentio/kafka-go/blob/c66d8ca149e7f1a7905b47a60962745ceb08a6a9/conn.go#L209" target="_blank" rel="noopener noreferrer">negotiate it's protocol Version<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</li> <li>Kafka-go <a href="https://github.com/segmentio/kafka-go/issues/237" target="_blank" rel="noopener noreferrer">doesn't support Kerberos authentication<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</li></ul> <h3 id="sarama"><a href="#sarama" class="header-anchor">#</a> Sarama</h3> <ul><li>Sarama guarantees compatibility <a href="https://github.com/Shopify/sarama/blob/master/README.md#compatibility-and-api-stability" target="_blank" rel="noopener noreferrer">with Kafka 2.4 through 2.6<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</li> <li>Sarama <a href="https://github.com/Shopify/sarama/issues/1732" target="_blank" rel="noopener noreferrer">has tied it's protocol usage to the Version field in Config<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</li></ul> <h3 id="conclusion"><a href="#conclusion" class="header-anchor">#</a> Conclusion</h3> <ul><li>Neither Kafka-go nor sarama is mature as Java clients. You need to try both if clickhouse_sinker fails to connect with Kafka.</li> <li>Our experience is sarama can't work well with new kafka server if set its <code>Config.Version</code> to &quot;0.11.0.0&quot;. So we suggest <code>KafkaConfig.Version</code> in clickhouse_sinker config matchs the Kafka server.</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/clickhouse_sinker/dev/design.html">
        Design
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/clickhouse_sinker/assets/js/app.b4dffbc3.js" defer></script><script src="/clickhouse_sinker/assets/js/3.133b48d1.js" defer></script><script src="/clickhouse_sinker/assets/js/14.b8380f5f.js" defer></script>
  </body>
</html>
